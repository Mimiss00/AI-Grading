<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Template Mo">
    <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900" rel="stylesheet">

    <title>Lecturer Page</title>

    <!-- Bootstrap core CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">


    <!-- Additional CSS Files -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/fontawesome.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/template-edu.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/owl.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/lightbox.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="{{ url_for('static', filename='assets/js/isotope.min.js') }}"></script>


  </head>

<body>

   


  </div>

  <!-- ***** Header Area Start ***** -->
  <header class="header-area header-sticky">
      <div class="container">
          <div class="row">
              <div class="col-12">
                  <nav class="main-nav">
                      <!-- ***** Logo Start ***** -->
                      <a href="{{ url_for('lecturer.dashboard_lecturer') }}" class="logo">
                          MIGRADE
                      </a>
                      <!-- ***** Logo End ***** -->
                      <!-- ***** Menu Start ***** -->
                     <ul class="nav">
                            <li class="scroll-to-section">
                              <a href="{{ url_for('lecturer.dashboard_lecturer') }}">Home</a>

                            </li>
                            <li class="has-sub">
                                <a href="javascript:void(0)">Pages <i class="fa fa-angle-down"></i></a>
                                <ul class="sub-menu">
                                <li><a href="{{ url_for('lecturer.my_classes') }}" class="active">Submissions</a></li>
                                <li><a href="{{ url_for('lecturer.all_assignment') }}">All Assignments</a></li>
                                </ul>
                            </li>

                          <li class="has-sub">
                              <span class="toggle" style="font-size: 28px;">
                              <i class="fas fa-user-circle"></i>
                              <ul class="sub-menu">
                                <li><a href="profile.html">Profile</a></li>
                                <li><a href="logout.html">Logout</a></li>
                              </ul>
                            </span>
                          </li>
                      </ul>    

                      <a class='menu-trigger'>
                          <span>Menu</span>
                      </a>
                      <!-- ***** Menu End ***** -->
                  </nav>
              </div>
          </div>
      </div>
  </header>
  <!-- ***** Header Area End ***** -->

  <section class="heading-page header-text" id="top">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <h6>Track Your Students' Assignment Submissions</h6>
          <h2>Assignment Overview</h2>
        </div>
      </div>
    </div>
  </section>

  

<section class="assignment-bg-wrapper py-5">
  <!-- ✅ Centered New Assignment Button -->
      <div class="d-flex justify-content-center mb-4">
  <a href="#uploadAssignmentModal" class="btn custom-capsule" data-bs-toggle="modal">
    ➕ New Assignment
  </a>
</div>

<div class="modal fade" id="uploadAssignmentModal" tabindex="-1" aria-labelledby="uploadAssignmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="uploadAssignmentModalLabel">📤 Upload Assignment & Answer Scheme</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4">
        <form id="uploadAssignmentForm">
          <div class="mb-3">
            <label for="title" class="form-label fw-semibold">Assignment Title</label>
            <input type="text" class="form-control" id="title" placeholder="e.g., Week 3: Loops and Functions" required>
          </div>

          <div class="mb-3">
            <label for="due_date" class="form-label fw-semibold">Due Date</label>
            <input type="date" class="form-control" id="due_date" required>
          </div>

          <div class="mb-3">
            <label for="assignment_file" class="form-label fw-semibold">Upload Assignment File</label>
            <input type="file" class="form-control" id="assignment_file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" required>
          </div>

          <div class="mb-3">
            <label for="answer_scheme" class="form-label fw-semibold">Upload Answer Scheme (JSON only)</label>
            <input type="file" class="form-control" id="answer_scheme" accept=".json" required>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label fw-semibold">Description / Notes</label>
            <textarea class="form-control" id="description" rows="3" placeholder="Any additional instructions..."></textarea>
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-primary px-4 rounded-pill">Upload Assignment</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Table section -->
<section class="assignment-table" style="padding-top: 50px; padding-bottom: 100px; position: relative;">
  <div class="container bg-white p-4 rounded shadow" style="background-color: rgba(255,255,255,0.95)">
    <h2 class="mb-4 text-center font-weight-bold text-dark">📚 All Assignments</h2>

    <div class="form-group">
      <input type="text" id="searchInput" class="form-control" placeholder="Search by title or description..." />
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-hover" id="assignmentTableElement">
        <thead class="thead-dark text-center">
          <tr>
            <th onclick="sortTable(0)">Title</th>
            <th onclick="sortTable(1)">Description</th>
            <th onclick="sortTable(2)">Due Date</th>
            <th>Assignment</th>
            <th>Answer Scheme</th>
            <th onclick="sortTable(5)">Uploaded</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="assignmentTable">
          <!-- Populated via JS -->
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <nav class="mt-3">
      <ul class="pagination justify-content-center" id="pagination">
        <!-- JS will populate -->
      </ul>
    </nav>
  </div>
</section>




  <!-- Scripts -->
  <!-- Bootstrap core JavaScript -->
      <script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>

      <!-- JS -->
      <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.min.js') }}"></script>
      <script src="{{ url_for('static', filename='assets/js/isotope.min.js') }}"></script>
      <script src="{{ url_for('static', filename='assets/js/owl-carousel.js') }}"></script>
      <script src="{{ url_for('static', filename='assets/js/lightbox.js') }}"></script>
      <script src="{{ url_for('static', filename='assets/js/tabs.js') }}"></script>
      <script src="{{ url_for('static', filename='assets/js/isotope.js') }}"></script>
      <script src="{{ url_for('static', filename='assets/js/video.js') }}"></script>
      <script src="{{ url_for('static', filename='assets/js/slick-slider.js') }}"></script>
      <script src="{{ url_for('static', filename='assets/js/custom.js') }}"></script>
      <script src="{{ url_for('static', filename='assets/js/isotope.min.js') }}"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

 





<script>
  document.querySelectorAll('.filters li').forEach(btn => {
    btn.addEventListener('click', function () {
      // Remove active class from all buttons
      document.querySelectorAll('.filters li').forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      const filterValue = this.getAttribute('data-filter');

      document.querySelectorAll('.mix').forEach(card => {
        if (filterValue === '*' || card.classList.contains(filterValue.replace('.', ''))) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    });
  });
</script>



<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, getDocs, deleteDoc, doc, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDWO1wHoJUv05yCZIrcK3CWpRcIpkVksvg",
    authDomain: "fyp-ai-3a972.firebaseapp.com",
    projectId: "fyp-ai-3a972",
    storageBucket: "fyp-ai-3a972.firebasestorage.app",
    messagingSenderId: "1095317736019",
    appId: "1:1095317736019:web:1fd2dafaea68314c9d54a6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const auth = getAuth(app);

  let assignments = [];
  let currentPage = 1;
  const rowsPerPage = 5;

  const tbody = document.getElementById("assignmentTable");
  const searchInput = document.getElementById("searchInput");
  const pagination = document.getElementById("pagination");

  async function loadAssignments() {
    const snapshot = await getDocs(collection(db, "assignments"));
    assignments = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
    renderTable();
    renderPagination();
  }

  function renderTable() {
    const searchQuery = searchInput.value.toLowerCase();
    const filtered = assignments.filter(a =>
      (a.title?.toLowerCase().includes(searchQuery) || a.description?.toLowerCase().includes(searchQuery))
    );

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageItems = filtered.slice(start, end);

    tbody.innerHTML = "";
    pageItems.forEach(data => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${data.title || '-'}</td>
        <td>${data.description || '-'}</td>
        <td>${data.dueDate || '-'}</td>
        <td><a href="${data.assignmentFileURL}" target="_blank" class="btn btn-outline-primary btn-sm">View</a></td>
        <td><a href="${data.answerSchemeFileURL}" target="_blank" class="btn btn-outline-secondary btn-sm">View</a></td>
        <td>${(data.uploadedAt || '-').split('T')[0]}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteAssignment('${data.id}')">Delete</button></td>
      `;
      tbody.appendChild(row);
    });

    renderPagination(filtered.length);
  }

  function renderPagination(totalRows = assignments.length) {
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    pagination.innerHTML = "";

    for (let i = 1; i <= totalPages; i++) {
      const li = document.createElement("li");
      li.className = `page-item ${i === currentPage ? 'active' : ''}`;
      li.innerHTML = `<button class="page-link" onclick="changePage(${i})">${i}</button>`;
      pagination.appendChild(li);
    }
  }

  window.changePage = function (page) {
    currentPage = page;
    renderTable();
  };

  window.deleteAssignment = async function (id) {
    if (confirm("Are you sure you want to delete this assignment?")) {
      await deleteDoc(doc(db, "assignments", id));
      assignments = assignments.filter(a => a.id !== id);
      renderTable();
    }
  };

  searchInput.addEventListener("input", () => {
    currentPage = 1;
    renderTable();
  });

  loadAssignments();

  // ✅ Upload with auth check and loading
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      alert("❌ You must be logged in to upload assignments.");
      return;
    }

    document.getElementById("uploadAssignmentForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const dueDate = document.getElementById("due_date").value;
      const description = document.getElementById("description").value.trim();
      const assignmentFile = document.getElementById("assignment_file").files[0];
      const answerSchemeFile = document.getElementById("answer_scheme").files[0];
      const uploadBtn = this.querySelector("button[type='submit']");
      const originalText = uploadBtn.innerHTML;

      if (!assignmentFile || !answerSchemeFile) {
        alert("Please upload both files.");
        return;
      }

      try {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Uploading...`;

        const assignmentRef = ref(storage, 'assignments/' + assignmentFile.name);
        await uploadBytes(assignmentRef, assignmentFile);
        const assignmentFileURL = await getDownloadURL(assignmentRef);

        const schemeRef = ref(storage, 'answer_schemes/' + answerSchemeFile.name);
        await uploadBytes(schemeRef, answerSchemeFile);
        const answerSchemeFileURL = await getDownloadURL(schemeRef);

        await addDoc(collection(db, "assignments"), {
          title,
          dueDate,
          description,
          assignmentFileURL,
          answerSchemeFileURL,
          uploadedAt: new Date().toISOString(),
          uploader: user.email || user.uid
        });

        

        const modalEl = document.getElementById('uploadAssignmentModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);

       if (modal) {
        modal.hide();
        document.body.classList.remove('modal-open');
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        }


        document.getElementById("uploadAssignmentForm").reset();
        loadAssignments();

      } catch (err) {
        console.error("❌ Upload failed:", err);
        alert("❌ Upload failed. See console.");
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = originalText;
      }
    });
  });
</script>




<script type="module" src="{{ url_for('static', filename='js/indexLecturer.js') }}"></script>






</body>
</html>
