<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Assignment - MiGrade</title>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    /* Your existing CSS, no changes needed */
    body {
      font-family: 'Ubuntu', sans-serif;
      background: #7494EC;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .upload-box {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
    .upload-box h2 {
      color: #4a5c94;
      margin-bottom: 10px;
    }
    .upload-box p {
      color: #7a89c2;
      font-size: 0.95rem;
      margin-bottom: 30px;
    }
    .drop-area {
      border: 2px dashed #c3ccf7;
      padding: 30px;
      border-radius: 12px;
      background: #f9f9ff;
      cursor: pointer;
      transition: 0.3s ease;
      position: relative;
    }
    .drop-area.drag-over {
      background: #e7edff;
      border-color: #7494EC;
    }
    .drop-area img {
      width: 70px;
      margin-bottom: 20px;
    }
    .drop-area span,
    .drop-area button {
      display: block;
      margin: 10px auto;
      color: #4a5c94;
    }
    .drop-area button {
      background-color: #4a5c94;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .drop-area button:hover {
      background-color: #3a4a76;
    }
    .file-selector-input {
      display: none;
    }
    .file-list {
      margin-top: 20px;
      text-align: left;
    }
    .file-item {
      background: #eef2ff;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      position: relative;
    }
    .file-item span {
      display: block;
      margin-top: 4px;
    }
    .file-progress {
      height: 6px;
      background: #c3ccf7;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }
    .file-progress span {
      display: block;
      height: 100%;
      background: #7494EC;
      width: 0;
      transition: width 0.3s ease;
    }
    .cancel-btn {
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 18px;
      color: red;
      font-weight: bold;
      cursor: pointer;
    }
    .success-text {
      margin-top: 5px;
      color: green;
      font-size: 0.85rem;
    }
  </style>
</head>

<body>
<div class="upload-box">
  <h2>UPLOAD FILES</h2>
  <p>Upload your assignment. PDF & Image are allowed.</p>
  <div class="drop-area" id="drop-area">
    <img src="/static/icon/upload.png" alt="Upload Cloud" />
    <span>Drag & Drop your files here</span>
    <span>OR</span>
    <button id="browseBtn">Browse Files</button>
    <input type="file" class="file-selector-input" id="fileInput" accept=".pdf,image/*" />
  </div>
  <div class="file-list" id="fileList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDWO1wHoJUv05yCZIrcK3CWpRcIpkVksvg",
  authDomain: "fyp-ai-3a972.firebaseapp.com",
  projectId: "fyp-ai-3a972",
  storageBucket: "fyp-ai-3a972.firebasestorage.app",
  messagingSenderId: "1095317736019",
  appId: "1:1095317736019:web:1fd2dafaea68314c9d54a6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const dropArea = document.getElementById('drop-area');
const browseBtn = document.getElementById('browseBtn');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const assignmentId = window.selectedAssignmentId || 'unknown';

// Browse button
browseBtn.addEventListener('click', () => fileInput.click());

// Handle file input change
fileInput.addEventListener('change', (e) => {
  [...e.target.files].forEach(file => {
    if (typeValidation(file.type)) uploadFile(file);
  });
});

// Drag and Drop
dropArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropArea.classList.add('drag-over');
});

dropArea.addEventListener('dragleave', () => {
  dropArea.classList.remove('drag-over');
});

dropArea.addEventListener('drop', (e) => {
  e.preventDefault();
  dropArea.classList.remove('drag-over');
  [...e.dataTransfer.files].forEach(file => {
    if (typeValidation(file.type)) uploadFile(file);
  });
});

// Validate file type
function typeValidation(type) {
  const splitType = type.split('/')[0];
  return type === 'application/pdf' || splitType === 'image';
}

// Upload File
async function uploadFile(file) {
  const fileItem = document.createElement('div');
  fileItem.className = 'file-item';
  const sizeMB = (file.size / (1024 * 1024)).toFixed(2);

  fileItem.innerHTML = `
    <strong>${file.name}</strong>
    <span class="file-size">${sizeMB < 0.01 ? '0.01 MB' : `${sizeMB} MB`}</span>
    <div class="file-progress"><span></span></div>
    <div class="cancel-btn">&times;</div>
  `;
  fileList.appendChild(fileItem);

  const progressBar = fileItem.querySelector('.file-progress span');
  const cancelBtn = fileItem.querySelector('.cancel-btn');

 // Ensure user is fetched before proceeding
    const user = await new Promise((resolve) => {
      const unsubscribe = auth.onAuthStateChanged((user) => {
        unsubscribe();
        resolve(user);
      });
    });

    // ✅ Inject UID into metadata
    const metadata = {
      customMetadata: {
        userUID: user.uid  // This is what your Firebase Storage rule uses
      }
    };

    const fileRef = ref(storage, `submissions/${user.uid}/${file.name}`);
    const uploadTask = uploadBytesResumable(fileRef, file, metadata); // ← with metadata here


  cancelBtn.onclick = () => {
    uploadTask.cancel();
    fileItem.remove();
  };

  uploadTask.on('state_changed',
    (snapshot) => {
      const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      progressBar.style.width = `${progress}%`;
    },
    (error) => {
      console.error('Upload failed:', error);
      fileItem.remove();
    },
    async () => {
      const fileURL = await getDownloadURL(uploadTask.snapshot.ref);

      // Fetch assignment name
      let assignmentName = "-";
      try {
        const assignmentDoc = await getDoc(doc(db, "assignments", assignmentId));
        if (assignmentDoc.exists()) {
          assignmentName = assignmentDoc.data().title || "-";
        }
      } catch (error) {
        console.error("Error fetching assignment:", error);
      }

      // Fetch student info
      const user = await new Promise((resolve) => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          unsubscribe();
          resolve(user);
        });
      });

      let studentName = "Unknown";
      let studentID = "Unknown";

      if (user) {
        const studentDoc = await getDoc(doc(db, "students", user.uid));
        if (studentDoc.exists()) {
          const studentData = studentDoc.data();
          studentName = (studentData.firstname || "Unknown").trim();
          studentID = (studentData.studentID || "Unknown").trim();
        }
      }

      // Save submission metadata
      await addDoc(collection(db, "submissions"), {
        assignmentId: assignmentId,
        assignmentName: assignmentName,
        studentName: studentName,
        studentID: studentID,
        studentUID: user.uid, 
        fileName: file.name,
        fileURL: fileURL,
        submittedAt: serverTimestamp(),
        status: "Pending",
        grade: "-"
      });

      cancelBtn.remove();
      progressBar.style.width = '100%';
      progressBar.style.backgroundColor = '#4CAF50';

      const success = document.createElement('div');
      success.className = 'success-text';
      success.innerText = '✅ Upload Successful';
      fileItem.appendChild(success);

      setTimeout(() => {
        window.location.href = '/student/my-assignment';
      }, 1500);
    }
  );
}
</script>